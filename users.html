<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CNYmesh — Community-Powered Meshtastic in Central New York</title>
  <meta name="description" content="CNYmesh is building a resilient, community-powered Meshtastic network across Central New York: Onondaga, Oswego, Madison, Oneida, Cayuga, and Cortland counties." />
  <link rel="preconnect" href="https://unpkg.com" />
  <link rel="stylesheet" href="css/site.css" />
  <link rel="icon" href="favicon.ico" />
  <meta property="og:title" content="CNYmesh — Community-Powered Meshtastic in Central New York" />
  <meta property="og:description" content="Join us to expand Meshtastic coverage across Syracuse and surrounding counties. Host a node, learn, and connect." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://cnymesh.org/" />
  <link rel="icon" type="image/png" href="/img/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="/img/favicon.svg" />
  <link rel="shortcut icon" href="/img/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png" />
  <meta name="apple-mobile-web-app-title" content="CNYmesh" />
  <link rel="manifest" href="/img/site.webmanifest" />
</head>
<body>
<header class="site-header">
  <div class="container">
    <a class="brand" href="/" aria-label="CNYmesh Home">
      <span class="brand-mark">CNY</span><span class="brand-mark accent">mesh</span>
    </a>
    <nav class="main-nav" aria-label="Primary">
      <a href="/#about">About</a>
      <a href="/#join">How to Join</a>
      <a href="/#resources">Technical</a>
      <a href="/#involved">Get Involved</a>
      <a href="/map.html">Coverage Map</a>
      <a class="btn btn-small" href="/faq.html">FAQ</a>
    </nav>
  </div>
</header>

<main id="content">
  <!-- Load User data from API https://api.cnymesh.org/users/{id}, username is passed as a query parameter -->
  <section id="about" class="section">
    <div class="container">
      <h2>About CNYmesh Users</h2>
      <p>
        This page lists users who have opted in to be publicly listed as part of the CNYmesh community.
        If you would like to be added, please email <a href="mailto:hello@cnymesh.org">hello@cnymesh.org</a>.
      </p>
    </div>
  </section>

  <section id="users" class="section">
    <div class="container">
      <script type="text/javascript">
         const urlParams = new URLSearchParams(window.location.search);
         const userId = urlParams.get("id");
         if (userId) {
           fetch(`https://api.cnymesh.org/users/${userId}`)
             .then(response => {
               if (!response.ok) {
                 throw new Error(`HTTP error! status: ${response.status}`);
               }
               return response.json();
             })
             .then(data => {
               const userList = document.getElementById("user-list");
               
               // Check if the API returned an error
               if (data.error) {
                 const errorItem = document.createElement("li");
                 errorItem.textContent = `Error: ${data.error}`;
                 errorItem.style.color = "red";
                 userList.appendChild(errorItem);
                 return;
               }
               
               // Check if we have valid user data
               if (!data.id) {
                 const errorItem = document.createElement("li");
                 errorItem.textContent = "Error: Invalid user data received";
                 errorItem.style.color = "red";
                 userList.appendChild(errorItem);
                 return;
               }
               
               // Display all fields for single user view
               const userItem = document.createElement("li");
               userItem.className = "user-details-card";
               
               let userHtml = `<h3>User Details</h3>`;
               
               // Define field display order and formatting
               const fieldOrder = ['id', 'name', 'email', 'location', 'notes', 'nodes'];
               const fieldLabels = {
                 'id': 'User ID',
                 'name': 'Name', 
                 'email': 'Email',
                 'location': 'Location',
                 'notes': 'Notes',
                 'nodes': 'Nodes'
               };
               
               // Fields to skip entirely
               const skipFields = ['is_admin', 'email_public'];
               
               // Display fields in preferred order, then any additional fields
               const displayedFields = new Set();
               
               fieldOrder.forEach(key => {
                 if (data.hasOwnProperty(key) && data[key] !== null && data[key] !== undefined && data[key] !== '' && !skipFields.includes(key)) {
                   const label = fieldLabels[key] || key.charAt(0).toUpperCase() + key.slice(1).replace(/([A-Z])/g, ' $1');
                   let value = data[key];
                   
                   // Special handling for different data types
                   if (key === 'nodes') {
                     // Handle nodes data structure
                     if (Array.isArray(value) && value.length === 0) {
                       value = 'No active nodes';
                     } else if (typeof value === 'object' && value !== null) {
                       // Convert nodes object to formatted display
                       const nodeIds = Object.keys(value);
                       if (nodeIds.length === 0) {
                         value = 'No active nodes';
                       } else {
                         let nodesHtml = `<div style="margin-top: 5px;">`;
                         nodeIds.forEach(nodeId => {
                           const node = value[nodeId];
                           nodesHtml += `
                             <div class="node-card">
                               <strong>${nodeId}</strong><br>
                               <small>
                                 Type: ${node.type || 'Unknown'}<br>
                                 Municipality: ${node.municipality || 'Unknown'}<br>
                                 Uptime: ${node.uptime || 'Unknown'}<br>
                                 Coverage: ${node.coverage_circle ? node.coverage_circle + ' miles' : 'Unknown'}<br>
                                 ${node.notes ? 'Notes: ' + node.notes + '<br>' : ''}
                                 Location: ${node.location ? node.location.lat + ', ' + node.location.lon : 'Unknown'}
                               </small>
                             </div>
                           `;
                         });
                         nodesHtml += `</div>`;
                         value = nodesHtml;
                       }
                     } else {
                       value = 'No active nodes';
                     }
                   } else if (key === 'email' && data.email_public !== false && value !== '--private--') {
                     value = `<a href="mailto:${value}">${value}</a>`;
                   } else if (typeof value === 'number') {
                     value = value.toString();
                   }
                   
                   userHtml += `<p><strong>${label}:</strong> ${value}</p>`;
                   displayedFields.add(key);
                 }
               });
               
               // Display any additional fields not in the predefined order
               Object.keys(data).forEach(key => {
                 if (!displayedFields.has(key) && !skipFields.includes(key) && data[key] !== null && data[key] !== undefined && data[key] !== '') {
                   const label = fieldLabels[key] || key.charAt(0).toUpperCase() + key.slice(1).replace(/([A-Z])/g, ' $1');
                   let value = data[key];
                   
                   if (typeof value === 'number') {
                     value = value.toString();
                   }
                   
                   userHtml += `<p><strong>${label}:</strong> ${value}</p>`;
                 }
               });
               
               userItem.innerHTML = userHtml;
               userList.appendChild(userItem);
             })
             .catch(error => {
               console.error('Error fetching user:', error);
               const userList = document.getElementById("user-list");
               const errorItem = document.createElement("li");
               errorItem.textContent = `Error loading user data for ${userId}: ${error.message}`;
               errorItem.style.color = "red";
               userList.appendChild(errorItem);
             });
         } else {
           fetch(`https://api.cnymesh.org/users`)
             .then(response => {
               if (!response.ok) {
                 throw new Error(`HTTP error! status: ${response.status}`);
               }
               return response.json();
             })
             .then(response => {
               const userList = document.getElementById("user-list");
               
               // Check if the API returned an error
               if (response.error) {
                 const errorItem = document.createElement("li");
                 errorItem.textContent = `Error: ${response.error}`;
                 errorItem.style.color = "red";
                 userList.appendChild(errorItem);
                 return;
               }
               
               // API returns: {"message": "List of users", "data": {"AK2X": {"id": "AK2X", "name": "..."}, ...}}
               if (!response.data || typeof response.data !== 'object') {
                 console.error('Invalid API response format:', response);
                 throw new Error('Invalid data format received from API');
               }
               
               const users = Object.values(response.data);
               
               if (users.length === 0) {
                 const noUsersItem = document.createElement("li");
                 noUsersItem.textContent = "No users found";
                 noUsersItem.style.fontStyle = "italic";
                 userList.appendChild(noUsersItem);
                 return;
               }
               
               // For list view, show only ID and Name
               users.forEach(user => {
                 // Validate each user object
                 if (user.id && user.name) {
                   const userItem = document.createElement("li");
                   userItem.innerHTML = `<strong>${user.id}</strong>: ${user.name}`;
                   userList.appendChild(userItem);
                 } else {
                   console.warn('Skipping invalid user data:', user);
                 }
               });
             })
             .catch(error => {
               console.error('Error fetching users:', error);
               const userList = document.getElementById("user-list");
               const errorItem = document.createElement("li");
               errorItem.textContent = `Error loading user data: ${error.message}`;
               errorItem.style.color = "red";
               userList.appendChild(errorItem);
             });
         }
        </script>
      <ul id="user-list" class="user-list">
        <!-- User entries will be populated here by JavaScript -->
         
      </ul>
    </div>
  </section>



  <!-- Contact -->
  <section id="contact" class="section">
    <div class="container">
      <h2>Contact / Collaborate</h2>
      <p>
        Interested in hosting a node, coordinating a router site, or connecting your city’s group?
        We’re especially looking to bridge Syracuse with Rochester, Buffalo, Ithaca, and Albany.
      </p>
      <ul class="contact-list">
        <li>Email: <a href="mailto:hello@cnymesh.org">hello@cnymesh.org</a></li>
        <li>API for live data: <code>https://api.cnymesh.org/</code></li>
      </ul>
    </div>
  </section>
</main>

<footer class="site-footer">
  <div class="container footer-grid">
    <div>
      <strong>CNYmesh</strong><br/>
      Central New York Meshtastic Community
    </div>
    <nav aria-label="Footer">
      <a href="/about.html">About</a>
      <a href="/how-to-join.html">How to Join</a>
      <a href="/technical-resources.html">Technical</a>
      <a href="/faq.html">FAQ</a>
      <a href="/map.html">Coverage Map</a>
    </nav>
    <div class="fineprint">© <span id="year"></span> CNYmesh</div>
  </div>
</footer>

<script src="js/home.js" defer></script>
<script src="js/dark-mode.js" defer></script>
</body>
</html>
