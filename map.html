<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CNYmesh Coverage Map</title>
  <meta name="description" content="Interactive coverage map showing CNYmesh Meshtastic network nodes and RF coverage across Central New York." />
  <link rel="preconnect" href="https://unpkg.com" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
  <link rel="stylesheet" href="css/site.css">
  <link rel="icon" href="favicon.ico" />
  <meta property="og:title" content="CNYmesh Coverage Map" />
  <meta property="og:description" content="Interactive map showing Meshtastic network coverage across Central New York." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://cnymesh.org/map.html" />
  <link rel="icon" type="image/png" href="/img/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="/img/favicon.svg" />
  <link rel="shortcut icon" href="/img/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png" />
  <meta name="apple-mobile-web-app-title" content="CNYmesh" />
  <link rel="manifest" href="/img/site.webmanifest" />
  <style>
    #map { height: calc(100vh - 80px); margin: 0; }
    .legend {
      background: var(--card-bg); 
      color: var(--text-color);
      padding:10px 12px; 
      border-radius:10px;
      border: 1px solid var(--border-color);
      box-shadow:0 2px 10px rgba(0,0,0,.15); 
      font:14px/1.4 system-ui, sans-serif;
    }
    .legend h4 { 
      margin:0 0 8px; 
      font-size:14px; 
      color: var(--text-color);
    }
    .legend .row { 
      display:flex; 
      align-items:center; 
      gap:8px; 
      margin:6px 0; 
      color: var(--text-color);
    }
    .swatch { 
      width:14px; 
      height:14px; 
      border-radius:3px; 
      border:1px solid var(--border-color); 
    }
    .county-label { 
      color: var(--text-color); 
      font-weight:600; 
      text-shadow: 0 0 3px var(--card-bg);
    }
  </style>
</head>
<body>
<header class="site-header">
  <div class="container">
    <a class="brand" href="/" aria-label="CNYmesh Home">
      <span class="brand-mark">CNY</span><span class="brand-mark accent">mesh</span>
    </a>
    <nav class="main-nav" aria-label="Primary">
      <a href="/#about">About</a>
      <a href="/#join">How to Join</a>
      <a href="/#resources">Technical</a>
      <a href="/#involved">Get Involved</a>
      <a href="/map.html" class="active">Coverage Map</a>
      <a class="btn btn-small" href="/faq.html">FAQ</a>
    </nav>
  </div>
</header>

<main id="content">
  <div id="map"></div>
</main>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
  // --- CONFIG ---
  const FOCUS_JSON = "data/focus-counties.json";
  const NY_GEOJSON = "data/ny-counties.geojson"; // keep this file in the repo
  const NODES_GEOJSON = "https://api.cnymesh.org/nodes"; // live nodes
  const REGIONAL = [
    {name:"Syracuse", lat:43.0481, lng:-76.1474},
    {name:"Rochester", lat:43.1566, lng:-77.6088},
    {name:"Buffalo", lat:42.8864, lng:-78.8784},
    {name:"Ithaca", lat:42.4439, lng:-76.5019},
    {name:"Albany", lat:42.6526, lng:-73.7562}
  ];

  // --- MAP ---
  const map = L.map('map', { zoomControl:true });
  const osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19, attribution: "&copy; OpenStreetMap contributors"
  }).addTo(map);

  let FOCUS = new Set();

  // Layers
  const countiesLayer = L.geoJSON(null, {
    style: f => {
      const name = (f.properties.NAME || f.properties.Name || f.properties.name || "").trim();
      const focused = FOCUS.has(name);
      return {
        color: focused ? "#2f855a" : "#6b7280",
        weight: focused ? 2 : 1,
        fillColor: focused ? "#34d399" : "#d1d5db",
        fillOpacity: focused ? 0.45 : 0.25
      };
    },
    onEachFeature: (f, layer) => {
      const name = (f.properties.NAME || f.properties.Name || f.properties.name || "County").trim();
      const focused = FOCUS.has(name);
      layer.bindPopup(`<strong>${name} County</strong><br>${focused ? "CNYmesh focus area" : "Neighboring county"}`);
      layer.on({
        mouseover: e => e.target.setStyle({ weight:3, fillOpacity: focused ? 0.6 : 0.35 }),
        mouseout: e => countiesLayer.resetStyle(e.target)
      });
    }
  }).addTo(map);

  const labelLayer = L.layerGroup().addTo(map);
  const regionalLayer = L.layerGroup(REGIONAL.map(c =>
    L.marker([c.lat, c.lng]).bindTooltip(c.name, {direction:"top"})
  ));

  function addCountyLabels() {
    labelLayer.clearLayers();
    countiesLayer.eachLayer(l => {
      const name = (l.feature.properties.NAME || l.feature.properties.name || "").trim();
      const c = l.getBounds().getCenter();
      const focused = FOCUS.has(name);
      
      // Estimate text width and height for centering
      const estimatedWidth = name.length * 8; // Rough estimate: 8px per character
      const estimatedHeight = 16; // Rough estimate for font height
      
      L.marker([c.lat, c.lng], {
        interactive:false,
        icon: L.divIcon({ 
          className:"county-label", 
          html:name, 
          iconSize:[estimatedWidth, estimatedHeight],
          iconAnchor:[estimatedWidth/2, estimatedHeight/2] // Center the icon
        })
      })[focused ? "addTo" : "addTo"](labelLayer);
    });
  }

  // Live nodes (points) and coverage circles
  const nodeMarker = (props={}) => {
    const html = `<div style="width:14px;height:14px;border-radius:50%;background:#2563eb;border:2px solid #fff;box-shadow:0 0 0 1px rgba(0,0,0,.25)"></div>`;
    return L.divIcon({ html, className:"", iconSize:[14,14] });
  };

  const nodesLayer = L.layerGroup();
  const coverageLayer = L.layerGroup();

  const processNodes = (data) => {
    // Clear existing layers
    nodesLayer.clearLayers();
    coverageLayer.clearLayers();

    // Handle proper GeoJSON format: {"type":"FeatureCollection","features":[{"type":"Feature","geometry":{"type":"Point","coordinates":[lon,lat]},"properties":{...}}]}
    if (data.type === "FeatureCollection" && data.features && Array.isArray(data.features)) {
      data.features.forEach(feature => {
        // Check if this is a proper GeoJSON Feature
        if (feature.type === "Feature" && feature.geometry && feature.properties) {
          // Extract coordinates from GeoJSON geometry
          if (feature.geometry.type === "Point" && feature.geometry.coordinates && feature.geometry.coordinates.length >= 2) {
            const [lon, lat] = feature.geometry.coordinates;
            const latlng = L.latLng(lat, lon);
            const props = feature.properties;
            
            // Create the node marker
            const marker = L.marker(latlng, { icon: nodeMarker(props) });
            
            // Build popup content with all available fields
            let popupContent = `<strong>${props.name || "Unknown Node"}</strong><br>`;
            
            if (props.host) {
              popupContent += `Host: <a href="/users.html?id=${props.host}" target="_blank">${props.host}</a><br>`;
            }
            if (props.type) {
              popupContent += `Type: ${props.type}<br>`;
            }
            if (props.municipality) {
              popupContent += `Municipality: ${props.municipality}<br>`;
            }
            if (props.uptime) {
              popupContent += `Uptime: ${props.uptime}<br>`;
            }
            if (props.coverage_circle) {
              popupContent += `Coverage: ${props.coverage_circle} miles<br>`;
            }
            if (props.notes) {
              popupContent += `Notes: ${props.notes}<br>`;
            }
            
            // Remove trailing <br> and add location coordinates
            popupContent = popupContent.replace(/<br>$/, '');
            popupContent += `<br><small>Coordinates: ${lat.toFixed(6)}, ${lon.toFixed(6)}</small>`;
            
            marker.bindPopup(popupContent);
            
            // Add marker to nodes layer
            nodesLayer.addLayer(marker);
            
            // Create coverage circle if coverage_circle property exists
            if (props.coverage_circle && typeof props.coverage_circle === 'number' && props.coverage_circle > 0) {
              const radiusInMeters = props.coverage_circle * 1609.34; // Convert miles to meters
              const circle = L.circle(latlng, {
                radius: radiusInMeters,
                color: '#2563eb',
                weight: 1,
                opacity: 0.6,
                fillColor: '#2563eb',
                fillOpacity: 0.1
              });
              
              circle.bindTooltip(`${props.name || "Node"} - ${props.coverage_circle} mile coverage`, {
                direction: 'top',
                offset: [0, -10]
              });
              
              // Add circle to coverage layer
              coverageLayer.addLayer(circle);
            }
          } else {
            console.warn('Skipping feature with invalid Point geometry:', feature);
          }
        } else {
          console.warn('Skipping invalid GeoJSON feature:', feature);
        }
      });
    } else {
      console.error('Invalid GeoJSON FeatureCollection format:', data);
    }
  };

  // Controls
  L.control.layers({ "OpenStreetMap": osm }, {
    "County Labels": labelLayer,
    "Regional Cities": regionalLayer,
    "Live Nodes": nodesLayer,
    "Coverage Areas": coverageLayer
  }, { collapsed:true }).addTo(map);

  // Legend
  const legend = L.control({ position:"bottomright" });
  legend.onAdd = () => {
    const div = L.DomUtil.create("div","legend");
    div.innerHTML = `
      <h4>CNYmesh Coverage</h4>
      <div class="row"><span class="swatch" style="background:#34d399"></span> Focus counties</div>
      <div class="row"><span class="swatch" style="background:#d1d5db"></span> Neighboring counties</div>
      <div class="row"><span class="swatch" style="background:#2563eb"></span> Live nodes</div>
      <div class="row"><span class="swatch" style="background:rgba(37,99,235,0.1);border:1px solid #2563eb"></span> RF coverage areas</div>
    `;
    return div;
  };
  legend.addTo(map);

  // Boot
  Promise.all([
    fetch(FOCUS_JSON).then(r=>r.json()).then(a => { FOCUS = new Set(a); }),
    fetch(NY_GEOJSON).then(r=>r.json())
  ]).then(([_, ny]) => {
    countiesLayer.addData(ny);
    addCountyLabels();

    // Fit to focus bounds
    const focusBounds = [];
    countiesLayer.eachLayer(l => {
      const nm = (l.feature.properties.NAME || l.feature.properties.name || "").trim();
      if (FOCUS.has(nm)) focusBounds.push(l.getBounds());
    });
    if (focusBounds.length) {
      const b = focusBounds.reduce((acc, cur) => acc.extend(cur), L.latLngBounds(focusBounds[0]));
      map.fitBounds(b.pad(0.1));
    } else {
      map.setView([43.05, -76.15], 8); // Syracuse
    }
  }).then(() => {
    // Load live nodes (non-blocking)
    fetch(NODES_GEOJSON, { mode: "cors" })
      .then(r => r.ok ? r.json() : Promise.reject(r.status))
      .then(gj => {
        processNodes(gj);
        nodesLayer.addTo(map);
        coverageLayer.addTo(map);
      })
      .catch(() => console.warn("Nodes endpoint unavailable or CORS blocked"));
  });
</script>
<script src="js/dark-mode.js" defer></script>
</body>
</html>
